---
layout:     post
title:      Android HAL层学习笔记
subtitle:   Android
date:       2018-10-22
author:     Muggle
header-img:
catalog: 	 true
tags:
    - Android驱动

---
## 一、HAL架构 ##
HAL(硬件抽象层，Hardware Abstraction Layer)是为了保护一些硬件提供商的知识产权而提出的，是为了避免Linux的GPL束缚。把控制硬件的动作都放到了HAL中。
<br>
新架构、调整为 HAL stub 的观念 主要包含以下一些模块：Gps、Vibrator、Wifi、Copybit、Audio、Camera、Lights、Ril、Overlay等。 
HAL架构是当前Android源码中使用的思路，每一个硬件模块称为一个stub（代理人），并且借尸so的形式编译，所有的stub都要通过libhardware.so(由hardware.c)才能找到每一个stub，才能回调每一个stub中硬件抽象接口，当然stub在编写时需要按照HAL_MODULE_INFO_SYM的格式来写，通过libhardware.so找到stub时，就会将该stub加载到内存，返回该stub的模块指针。优点：采用HAL module和HAL stub结合形式，HAL stub不是共享库，上层只拥有访问stub的函数指针，并不需要stub，Runtime只需要根据module ID并通过HAL module提供的统一接口就能取得stub的操作函数，只会被映射到一个进程，不会浪费空间。
![](https://i.imgur.com/qrtgvMc.jpg)

## 二、编写一款支持HAL的Linux的驱动程序步骤 ##
**第1步：编写Linux驱动** <br>
为Linux驱动添加HAL, 尽量保护敏感数据，代码尽量简洁，将业务逻辑放到HAL Library中。<br>
**第2步：编写HAL Library**
HAL Library就是普通的Linux Library（*.so）文件，这类库文件有一个接口，通过`HAL_MODULE_INFO_SYM`变量实现。Service Library就是通过这个接口定义的ID来找到HAL Library的

